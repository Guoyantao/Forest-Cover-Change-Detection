
/*
  This file will be used to download our sentinel-2 dataset
*/
// start by creating an AOI first, we'll do it using a polygon instance from geometry
// var pakistan = /* color: #98ff00 */ee.Geometry.Polygon(
//         [[[73.65007590061041, 33.924912470572],
//           [74.31637228732916, 33.924912470572],
//           [74.31637228732916, 34.44520782244974],
//           [73.65007590061041, 34.44520782244974]]]);

var pakistan = /* color: #d63000 */ee.Geometry.Polygon(
        [[[74.06318457379723, 33.9643816779208],
          [74.43122656598473, 33.960964648223325],
          [74.42847998395348, 34.23729874990755],
          [74.06593115582848, 34.229351137749404]]]);
          
var germany = /* color: #d63000 */ee.Geometry.Polygon(
        [[[7.7552313346861865, 49.278817914014034],
          [8.105420543670562, 49.27971381160097],
          [8.104047252654937, 49.46659938059896],
          [7.7634710807799365, 49.46570688270015]]]);

var forest_pakistan = /* color: #98ff00 */ee.Geometry.MultiPolygon(
        [[[[73.5895835865382, 34.403134898931285],
           [73.60447521098888, 34.40320571630766],
           [73.60580558666027, 34.41163255610692],
           [73.58954067119396, 34.411667961205985]]],
         [[[73.42946269763456, 34.43925740192843],
           [73.43954780353056, 34.4391866150804],
           [73.43946197284208, 34.445451018929944],
           [73.42924812091337, 34.44516789216815]]],
         [[[73.43272424587678, 34.43044252201926],
           [73.44032026180696, 34.43044252201926],
           [73.44006276974153, 34.434406907957715],
           [73.43276716122102, 34.434300721499696]]],
         [[[73.55377672967813, 34.38952657630883],
           [73.57214449701212, 34.389384918344],
           [73.57205866632364, 34.403478711071074],
           [73.55214594659708, 34.403478711071074]]],
         [[[73.52090357599161, 34.38258505413476],
           [73.54261874017618, 34.38272672360544],
           [73.54279040155313, 34.387685004068345],
           [73.52116106805704, 34.387755834519005]]],
         [[[73.5367034796061, 34.40457018146655],
           [73.53700388701577, 34.39231808339634],
           [73.55249632628579, 34.392176430155516],
           [73.5526250723185, 34.40471181372965]]],
         [[[73.53796724633935, 34.387930438764066],
           [73.54629282312158, 34.38807209919014],
           [73.54560617761376, 34.39200308038969],
           [73.53852514581445, 34.39189684008173]]],
         [[[73.55142891291712, 34.38041108019145],
           [73.55271637324427, 34.38034024352718],
           [73.56683552149866, 34.37949019888211],
           [73.56670677546595, 34.38657364059614],
           [73.55155765894983, 34.386750718961125]]],
         [[[73.52099020087041, 34.387404455565495],
           [73.5150249680213, 34.387439870916985],
           [73.5148103913001, 34.38297741864808],
           [73.52068979346075, 34.38272949765938]]],
         [[[73.49462636120222, 34.38628255994732],
           [73.49595673687361, 34.38589298487149],
           [73.510075885128, 34.385680488611534],
           [73.50999005443953, 34.391984314980135],
           [73.49441178448103, 34.39155935284397]]],
         [[[73.56003365968809, 34.40954937916967],
           [73.57333741640196, 34.40887666268641],
           [73.57243619417295, 34.41478930130807],
           [73.55775914644346, 34.41457687841669]]],
         [[[73.55770741825563, 34.42042298617885],
           [73.56654797916872, 34.42013977461757],
           [73.56667672520143, 34.42506043902899],
           [73.55830823307497, 34.42488344173339]]],
         [[[73.56681282929253, 34.41890071275818],
           [73.58432228974175, 34.41783864512231],
           [73.58475144318413, 34.42467104448402],
           [73.56702740601372, 34.42477724317616]]],
         [[[73.59476929930656, 34.41195486987755],
           [73.60652810362785, 34.4117070347195],
           [73.60734349516838, 34.42084104526692],
           [73.59597092894523, 34.42077024282053]]],
         [[[73.58002795676157, 34.40557278108372],
           [73.58895434836313, 34.40567900403054],
           [73.58916892508432, 34.41732730206981],
           [73.57908381918833, 34.41707948283179]]],
         [[[73.56174720246929, 34.4091416420209],
           [73.56114638764996, 34.403901366080476],
           [73.57329143006939, 34.40379514087665],
           [73.57337726075787, 34.40861054792128]]],
         [[[73.57236067805957, 34.39825172419546],
           [73.5778967574663, 34.398322545704715],
           [73.57742468867968, 34.40331531104219],
           [73.57214610133838, 34.4032090850943]]],
         [[[73.5208474107526, 34.39825494146786],
           [73.53612527330142, 34.39850281647851],
           [73.53603944261295, 34.402539534733435],
           [73.5211907335065, 34.40239789879303]]],
         [[[73.52319812023768, 34.413122961835384],
           [73.52924918377528, 34.41308755735223],
           [73.52929209911952, 34.42239842005223],
           [73.52341269695887, 34.42243382059356]]],
         [[[73.53306864941248, 34.41974333673568],
           [73.53886222088465, 34.41970793505522],
           [73.53881930554041, 34.423248028906826],
           [73.53366946423182, 34.42321262871027]]],
         [[[73.52980708325038, 34.41014893300589],
           [73.53469943249354, 34.41029055582419],
           [73.53469943249354, 34.418645877672034],
           [73.52984999859461, 34.41843346457669]]],
         [[[73.52875777355962, 34.406838187730955],
           [73.53626795880132, 34.40719225834024],
           [73.53605338208013, 34.41044963763115],
           [73.528285704773, 34.40998936347028]]],
         [[[73.53829957280004, 34.41114921480997],
           [73.54233361515844, 34.4110784041577],
           [73.54293442997778, 34.41383997517541],
           [73.53885747227514, 34.41362754987275]]],
         [[[73.55853004884545, 34.415608228155115],
           [73.56887264680688, 34.41511257875602],
           [73.5695592923147, 34.4174845885554],
           [73.55960293245141, 34.41865286715944]]],
         [[[73.56966678304047, 34.41847296216118],
           [73.56962386769624, 34.41468483980706],
           [73.57842151326508, 34.41418918493541],
           [73.57876483601899, 34.417906524869856],
           [73.56962386769624, 34.418720777269606]]],
         [[[73.55906229670325, 34.42777176097133],
           [73.56446963007727, 34.427736362690304],
           [73.56434088404455, 34.4332229173386],
           [73.56026392634192, 34.43357687623883]]],
         [[[73.57680964298902, 34.424985509304626],
           [73.58612227268873, 34.424560714784896],
           [73.5864226800984, 34.429835093745204],
           [73.57719588108716, 34.43033065587264]]],
         [[[73.57599425144849, 34.42951651654034],
           [73.5659091455525, 34.42979969633794],
           [73.56582331486402, 34.42533950308891],
           [73.57552218266187, 34.4251271069982]]],
         [[[73.61958092776501, 34.399246711879734],
           [73.63103932467664, 34.399069659949554],
           [73.63095349398816, 34.40239817355731],
           [73.6200100812074, 34.40250440053473]]],
         [[[73.6169268825688, 34.39902060157262],
           [73.61674851504529, 34.395599366493485],
           [73.62949437228406, 34.3955285426797],
           [73.62958020297253, 34.39910507036554],
           [73.61773556796277, 34.39903424951856]]],
         [[[73.6360946276892, 34.37854687931745],
           [73.64553600342163, 34.37840520277518],
           [73.64510684997924, 34.39122595912001],
           [73.63583713562377, 34.39115513160546]]],
         [[[73.62492795400271, 34.38464591064435],
           [73.63308186940799, 34.384893825958656],
           [73.63316770009646, 34.389533248564405],
           [73.62458463124881, 34.389533248564405]]],
         [[[73.64859706026573, 34.39162486572315],
           [73.65670806032676, 34.39201441412549],
           [73.65636473757286, 34.3963347384849],
           [73.64816790682335, 34.39626391529342]]],
         [[[73.64239730823192, 34.39802059893158],
           [73.64960708606395, 34.398197653081354],
           [73.64913501727733, 34.40311960848135],
           [73.64286937701854, 34.40308419976423]]],
         [[[73.29101379834754, 34.46173145739198],
           [73.28187283002478, 34.461766841270965],
           [73.2817869993363, 34.45720219707111],
           [73.29088505231482, 34.45759144003006]]],
         [[[73.30412925595533, 34.46122454193855],
           [73.29327167386305, 34.46136607822386],
           [73.29335750455152, 34.45266115029959],
           [73.30344261044752, 34.45251959925829]]],
         [[[73.22183218113673, 34.48183670684146],
           [73.2145151149441, 34.48206664638415],
           [73.21442928425563, 34.476937075191564],
           [73.22131719700587, 34.47663636640481]]],
         [[[73.1091483365285, 34.5191711896683],
           [73.12296707737323, 34.51927726817216],
           [73.12335331547138, 34.528258091617296],
           [73.10910542118427, 34.52783382253986]]],
         [[[73.09396445192647, 34.508832827675164],
           [73.10709654726338, 34.50869137190967],
           [73.10769736208272, 34.51834517687168],
           [73.09392153658223, 34.51834517687168]]],
         [[[73.12467269909394, 34.51954289516298],
           [73.13677482616913, 34.51858818680976],
           [73.13656024944794, 34.53071570544366],
           [73.12467269909394, 34.53057428683165]]],
         [[[73.13753940078436, 34.51842951537849],
           [73.14629413100897, 34.51860631438386],
           [73.1459937235993, 34.5290014362094],
           [73.13753940078436, 34.5290014362094]]],
         [[[73.1873339623304, 34.52521610502261],
           [73.16853704155403, 34.52542824649935],
           [73.16819371880013, 34.51185010271111],
           [73.18810643852669, 34.51188546533455]]],
         [[[72.98358855735455, 34.36885001972189],
           [72.99556193839703, 34.36941678910491],
           [72.99547610770855, 34.37915753853564],
           [72.98363147269879, 34.378945025181956]]],
         [[[72.98502380741479, 34.37904565923928],
           [72.99180443180444, 34.37939984743685],
           [72.99146110905053, 34.38354373805091],
           [72.98528129948022, 34.38347290403673]]],
         [[[73.05721526574416, 34.42314871964971],
           [73.06682830285354, 34.42318411987334],
           [73.06682830285354, 34.43097180467364],
           [73.05627112817092, 34.43107799536126]]],
         [[[73.43398288662036, 34.17362437291598],
           [73.4338112252434, 34.20323080425824],
           [73.40514377529223, 34.202836352392204],
           [73.40445712978442, 34.17266168922846]]],
         [[[73.41471211540033, 34.20323322227853],
           [73.43513981925776, 34.20323322227853],
           [73.43479649650385, 34.2245263838447],
           [73.41514126884272, 34.22402960472083]]],
         [[[73.33599699233196, 34.21588191393173],
           [73.35642469618938, 34.216023864851245],
           [73.3563388655009, 34.225037258475666],
           [73.33634031508586, 34.22482435478696]]],
         [[[73.34261537993211, 34.19962778728795],
           [73.36235643828172, 34.19941481939338],
           [73.36227060759325, 34.21219194081998],
           [73.34261537993211, 34.21219194081998]]],
         [[[73.33395167746016, 34.08631761945698],
           [73.36030169882247, 34.08667304109991],
           [73.36064502157637, 34.09847219256491],
           [73.33395167746016, 34.0982589694811]]],
         [[[73.84580396860247, 34.52358690598448],
           [73.8720681592763, 34.52337475981777],
           [73.87223982065325, 34.53362787309855],
           [73.84657644479876, 34.53327433848306]]],
         [[[73.85355492497547, 34.5459932481598],
           [73.89312287236316, 34.545569069456086],
           [73.89363785649402, 34.55673838747633],
           [73.85458489323719, 34.55652632578187]]],
         [[[73.89790089443068, 34.55821982816048],
           [73.92579586818556, 34.55779571178391],
           [73.9263966830049, 34.56853932681221],
           [73.89850170925001, 34.56811526305611]]],
         [[[73.95274553521585, 34.61937233416632],
           [73.96922502740335, 34.61923106628973],
           [73.97034082635355, 34.63780572869844],
           [73.9525738738389, 34.63794696495128]]],
         [[[73.96978803571994, 34.59519682715668],
           [73.9992279618674, 34.594560934701896],
           [74.0000004380637, 34.610103577601414],
           [73.96935888227756, 34.610103577601414]]],
         [[[74.00380584617153, 34.59499433446539],
           [74.05564758201137, 34.59584218556657],
           [74.05530425925747, 34.61110202551135],
           [74.00397750754848, 34.61152586992543]]],
         [[[74.27165817501327, 34.515369524260265],
           [74.30513214351913, 34.51579385682787],
           [74.30496048214218, 34.53290680217403],
           [74.2730314660289, 34.53290680217403]]],
         [[[74.30908035518905, 34.49768707977509],
           [74.34358429195663, 34.49782855421624],
           [74.34324096920272, 34.52470434150988],
           [74.31062530758163, 34.523855764985505]]],
         [[[74.34966833094302, 34.50079946202462],
           [74.37249929407778, 34.50037505310539],
           [74.37335760096255, 34.51989562689504],
           [74.35138494471255, 34.52145141788397]]],
         [[[74.34033716762269, 34.46773684893592],
           [74.38050592982972, 34.467383034776084],
           [74.3802484377643, 34.48188818540899],
           [74.3417962893268, 34.48167593309187]]],
         [[[74.3624585257487, 34.43841250924401],
           [74.3976491080241, 34.437421477893785],
           [74.39679080113933, 34.463326005546755],
           [74.36314517125652, 34.46247680417225]]],
         [[[74.33701521729267, 34.423763154747995],
           [74.34920317505635, 34.424471151169286],
           [74.34954649781025, 34.4365769620544],
           [74.33744437073506, 34.4363645945182]]],
         [[[74.15762424473644, 34.315633050456],
           [74.19899463658214, 34.316979975976956],
           [74.19993877415538, 34.33328314936916],
           [74.15779590611339, 34.3337084071503]]],
         [[[74.12944557287994, 34.30201171395536],
           [74.1574263773233, 34.30243713020038],
           [74.15725471594635, 34.32817080365723],
           [74.13013221838776, 34.327603755376074]]],
         [[[74.12751963913456, 34.27945510857603],
           [74.16416934311405, 34.27902957595284],
           [74.16408351242558, 34.29484375717582],
           [74.12889293015019, 34.29448921173835]]],
         [[[72.89424867043226, 34.50990590532817],
           [72.9043766916725, 34.51004735903215],
           [72.90454835304945, 34.514856642101606],
           [72.89467782387464, 34.51450302780106]]],
         [[[72.87812185187124, 34.50852725405497],
           [72.88490247626089, 34.50835043366222],
           [72.8846878995397, 34.51323053878631],
           [72.8786368360021, 34.51323053878631]]],
         [[[72.89751452811572, 34.5427535552112],
           [72.90738505729053, 34.5427535552112],
           [72.90734214194629, 34.54561681636715],
           [72.89768618949267, 34.54533402952581]]],
         [[[73.29875417909989, 34.52000689146056],
           [73.31407495699295, 34.52060799516612],
           [73.31407495699295, 34.526194516223136],
           [73.29866834841141, 34.52598237669819]]],
         [[[73.30316092541239, 34.52604411555891],
           [73.31290270855447, 34.52622089840283],
           [73.31283833553812, 34.532142906823125],
           [73.3033969598057, 34.53235503065496]]],
         [[[73.30744850004567, 34.534406348673606],
           [73.31783401335133, 34.53444170172206],
           [73.31740485990895, 34.539603085701366],
           [73.30796348417653, 34.53949703308628]]],
         [[[73.28136915598702, 34.560367512697695],
           [73.29630369578194, 34.55990806505484],
           [73.2962607804377, 34.566516798373726],
           [73.28115457926583, 34.566552137781976]]],
         [[[73.28662171597671, 34.58658609499085],
           [73.2972647213478, 34.58637410941116],
           [73.29855218167495, 34.59322803587363],
           [73.28670754666518, 34.59252147165626]]],
         [[[73.32117986900255, 34.52009322349058],
           [73.33212328178331, 34.51991642764083],
           [73.33216619712755, 34.52355834639631],
           [73.32139444572374, 34.52362906168939]]],
         [[[73.30468512340508, 34.5107950714633],
           [73.32245207591973, 34.510547529544866],
           [73.32262373729668, 34.515887199200186],
           [73.30537176891289, 34.51549822819821]]],
         [[[73.30716031620125, 34.50410978255393],
           [73.31707376072029, 34.50393295278922],
           [73.31690209934334, 34.5075755702089],
           [73.30711740085701, 34.5080706709664]]],
         [[[73.28756372852308, 34.504463440957956],
           [73.29485933704359, 34.50410978255393],
           [73.2940868608473, 34.517264864777665],
           [73.28722040576918, 34.51754774696076]]],
         [[[73.8598519618339, 34.45472430344214],
           [73.89821827958292, 34.45422888598747],
           [73.89787495682901, 34.464844330968205],
           [73.86088193009562, 34.46491509607238]]],
         [[[73.86113942216105, 34.43450894710492],
           [73.88800442765421, 34.43472131935689],
           [73.88714612076944, 34.448736694654784],
           [73.86148274491495, 34.448524358025765]]],
         [[[73.89242344460422, 34.42019535895807],
           [73.91396694741184, 34.41984134339284],
           [73.9148252542966, 34.432160203513476],
           [73.89276676735813, 34.43237258173399]]],
         [[[74.00967113795912, 34.41825631699107],
           [74.06048290553724, 34.41797309809125],
           [74.05996792140638, 34.451103199022526],
           [74.0112160903517, 34.45067853725714]]],
         [[[73.99471043788617, 34.41939261619663],
           [74.009988300435, 34.419109401145406],
           [74.00930165492719, 34.44785083567122],
           [73.99488209926312, 34.44742615736946]]],
         [[[74.02662430501186, 34.40332697970254],
           [74.09374390340054, 34.402477168461665],
           [74.09271393513882, 34.418338888311126],
           [74.02765427327358, 34.41805566969099]]],
         [[[74.13621618548189, 34.35655625196908],
           [74.1698618153647, 34.35669796546388],
           [74.1702051381186, 34.3670424033678],
           [74.13655950823579, 34.36675901112401]]],
         [[[74.10544144789174, 34.35098805001243],
           [74.08664452711537, 34.35077546519995],
           [74.08621537367299, 34.3285219407504],
           [74.10587060133412, 34.328663701628614]]],
         [[[74.12488986716755, 34.34177752064184],
           [74.15810634360798, 34.34234447311625],
           [74.15810634360798, 34.35099002340033],
           [74.12523318992146, 34.350777438592864]]],
         [[[74.09391674209428, 34.352432231963654],
           [74.11940845657182, 34.35314083190423],
           [74.11923679519487, 34.37241245282938],
           [74.09262928176713, 34.37276666907926]]],
         [[[74.10853632004034, 34.406770398889854],
           [74.07763727218878, 34.40712446978604],
           [74.07703645736945, 34.392039721834536],
           [74.10930879623663, 34.3924646815319]]],
         [[[74.13473910449864, 34.397693489820874],
           [74.14701289295078, 34.39776431180256],
           [74.1465837395084, 34.404775391298145],
           [74.13516825794102, 34.404775391298145]]],
         [[[74.06062836226783, 34.418835914486415],
           [74.0886091667112, 34.419048326559455],
           [74.08835167464576, 34.4357563853851],
           [74.06105751571022, 34.43561480569733]]],
         [[[74.08808247378306, 34.29885666037659],
           [74.12730709841685, 34.29878575479614],
           [74.12696377566294, 34.31353282688473],
           [74.08928410342173, 34.31353282688473]]],
         [[[74.182309214709, 34.2884903665468],
           [74.2181864424922, 34.28919950655559],
           [74.21887308800001, 34.30182119729365],
           [74.18351084434767, 34.30082854875682]]],
         [[[73.325929141615, 34.28183685763096],
           [73.35116336402712, 34.282404215033836],
           [73.35116336402712, 34.290275903761376],
           [73.32678744849977, 34.29034681652467]]],
         [[[73.34894495889353, 34.29126867700119],
           [73.36181956216501, 34.291623236029736],
           [73.36164790078806, 34.297225070096346],
           [73.34885912820505, 34.2965869053219]]],
         [[[73.3336670963447, 34.29070137944338],
           [73.349030789582, 34.29055955445544],
           [73.3486874668281, 34.29573601141449],
           [73.33383875772165, 34.295594194925314]]],
         [[[73.34557654206606, 34.26791137534511],
           [73.35759283845277, 34.26798230697794],
           [73.35759283845277, 34.27606812092238],
           [73.3454048806891, 34.27599719611052]]],
         [[[73.3540945083156, 34.23616640518329],
           [73.37563801112321, 34.236592154676345],
           [73.37598133387712, 34.24517764326542],
           [73.35469532313493, 34.245248594068244]]],
         [[[73.29920463582914, 34.23044772040873],
           [73.31302337667387, 34.23037675713121],
           [73.31285171529692, 34.24719338143395],
           [73.29989128133695, 34.24719338143395]]],
         [[[73.3061140062515, 34.24093348944114],
           [73.3152978899185, 34.24093348944114],
           [73.3152978899185, 34.24831242466404],
           [73.30658607503813, 34.248135054002084]]],
         [[[73.32365347983739, 34.245382130814725],
           [73.34058358313939, 34.245417606137416],
           [73.34069087149999, 34.25187386585093],
           [73.32440449836156, 34.25190933843715]]]]);



// Draw it on the map to see what we get on the map
// Map.addLayer(germany);

// some utilities

// crop function for croping out our main region of interest
function cropout_aoi(image){
  return image.clip(this_aoi); // but this is the one that actually does the cropping
}
/*
 * Function to mask clouds using the Sentinel-2 QA band
 * @param {ee.Image} image Sentinel-2 image
 * @return {ee.Image} cloud masked Sentinel-2 image
*/
function maskS2clouds(image) {
  var qa = image.select('QA60')

  // Bits 10 and 11 are clouds and cirrus, respectively.
  var cloudBitMask = 1 << 10;
  var cirrusBitMask = 1 << 11;

  // Both flags should be set to zero, indicating clear conditions.
  var mask = qa.bitwiseAnd(cloudBitMask).eq(0).and(
             qa.bitwiseAnd(cirrusBitMask).eq(0))

  // Return the masked and scaled data, without the QA bands.
  return image.updateMask(mask) //.divide(10000)
      .select("B.*")
      .copyProperties(image, ["system:time_start"])
}

function scale(image, div) {
  return image.float().divide(div).multiply(255).uint8(); //.cast(ee.uint8);
}


// declare vars here
var all_bands = ['B1', 'B2', 'B3', 'B4', 'B5', 
                 'B6', 'B7', 'B8', 'B8A', 
                 'B9', 'B10', 'B11', 'B12'];
var landsat_8 = 'LANDSAT/LC08/C01/T1';
var sentinel_2 = 'COPERNICUS/S2';
var show_bands = ('B4', 'B3', 'B2');
var export_bands = all_bands; //('B4', 'B3', 'B2', 'B5', 'B8');
var this_collection = sentinel_2;
var allowed_cloud_percentage = 5;
var this_aoi = forest_pakistan[0][];
print(this_aoi);
var this_max = 0.3*10000;
var description = 'pakistan_forest_';
var folder = 'pakistan_forest_sentinel_';
var prefix_name = 'forest_pak_';


// the following function returns mosaice images
function get_images(){
  var count  = 1;
  var month; var month_interval = 11; var month_end = 11; // download one image for 6-month interval
  var year; var year_interval = 1; var year_end = 2019;
  for (year = 2015; year < year_end; year+=year_interval) {
    for (month = 01; month < month_end; month+=month_interval) {
      var next_month = month + month_interval;
      print('currently on (' + month + '/' + year + ')->(' + next_month + '/' + year + ')');
      // Now define the required dates to get the data from 
      var date_from = year + '-' + month + '-01';
      var date_to = year + '-' + next_month + '-31';
      // import sentinel images, clip your area of interest, dates and cloud cover as needed
      // print(date_from, date_to)
      var collection = ee.ImageCollection('COPERNICUS/S2')
      .filterDate(date_from, date_to)
      // Pre-filter to get less cloudy granules.
      .filter(ee.Filter.lt('CLOUDY_PIXEL_PERCENTAGE', allowed_cloud_percentage))
      .map(cropout_aoi)
      .map(maskS2clouds);
  
      var composite = collection.median();
      // var count = 4;
      // Display the results.
      Map.addLayer(composite, {bands: ['B4', 'B3', 'B2'], min: 0, max: 0.3*10000}, 'RGB');
      Export.image.toDrive({
                        image: composite.select(export_bands), 
                        description: description + count, 
                        folder: folder, 
                        fileNamePrefix: prefix_name + count, 
                        // dimensions, 
                        region: this_aoi, 
                        scale: 10
                        });
      count += 1;
    }
  }
}


// the following function returns all images in a bad form, because all of them are incomplete
function get_all_images(){  
  var date_from = ee.Date({date: '2018-06-01'});
  var date_to = ee.Date({date: '2018-07-31'});
  
  // import sentinel images, clip your area of interest, dates and cloud cover as needed
  var image_collection = ee.ImageCollection('COPERNICUS/S2')
                          // .filter(ee.Filter.lt('CLOUDY_PIXEL_PERCENTAGE', 1))
                          .filterDate({start:date_from, end:date_to})
                          .filterBounds(rawalLake) // locates ones close to this polygon
                          .map(cropout_aoi) // actually does the clipping part 
                          .map(maskS2clouds);
  var all_bands = ['B1', 'B2', 'B3', 'B4', 'B5', 'B6', 'B7', 'B8', 'B8A', 'B9', 'B10', 'B11', 'B12'];
  var total_count = image_collection.size();
  var count = 1;
  print('log: total images in collection =', total_count);
  function exporter(image)
  {
    try{
    Export.image.toDrive({
                        image: image.select('B2', 'B3', 'B4'), 
                        description: 'rawalLake' + count, 
                        folder: 'rawalLake', 
                        fileNamePrefix: 'rawalLake_' + count, 
                        // dimensions, 
                        region: rawalLake, 
                        scale: 10
                        });
    print('exported ' + count);
    count += 1;
    // Map.addLayer(image, {bands: ['B4', 'B3', 'B2'], min: 0, max: 5000});
    }
    catch(err) {
        print('INFO: something bad happened here');
    }
    finally {
    return 1;
    }
  }
  // image_collection.map(exporter);
  // Map.addLayer(rawalLake);
  Map.addLayer(image_collection);
  var total_found = 6;
  var colList = image_collection.toList(total_found);
  for (var i=0; i < total_found; i++){
    var img = ee.Image(colList.get(i));
    print(img)
    exporter(img);  
    Map.addLayer(img, {bands: ['B4', 'B3', 'B2'], min: 0, max: 5000});
  }
}


/*////////////////////////////////////////////////////////////////////////////////////////
//  make function calls beyond this point                                                //
*/////////////////////////////////////////////////////////////////////////////////////////
// get_images();


// random codes for rawal lake
// var date_from = ee.Date({date: '2018-08-01'});
// var date_to = ee.Date({date: '2018-08-31'});
// // import sentinel images, clip your area of interest, dates and cloud cover as needed
// var image_collection = ee.ImageCollection('LANDSAT/LE07/C01/T1_RT') //
//                       // .filter(ee.Filter.lt('CLOUDY_PIXEL_PERCENTAGE', 5))
//                       .filterDate({start:date_from, end:date_to})
//                       .filterBounds(rawalLake) // locates ones close to this polygon
//                       .map(cropout_aoi) // actually does the clipping part 
//                       // .map(maskS2clouds);
// var all_bands = ['B1', 'B2', 'B3', 'B4', 'B5', 'B6', 'B7', 'B8', 'B8A', 'B9', 'B10', 'B11', 'B12'];
// var total_count = image_collection.size();
// print('log: total images in collection =', total_count);
// var this_image = image_collection.median();
// // this_image = scale(this_image, 10);
// Map.addLayer(this_image, {bands: ['B3', 'B2', 'B1']});
// Export.image.toDrive({
//                       image: this_image.select('B3', 'B2', 'B1'), 
//                       description: 'landsat_rawal', 
//                       folder: 'landsat_rawal', 
//                       fileNamePrefix: 'landsat_rawal_august', 
//                       // dimensions, 
//                       region: rawalLake, 
//                       scale: 10
//                       });


// This example uses the Sentinel-2 QA band to cloud mask
// the collection.  The Sentinel-2 cloud flags are less
// selective, so the collection is also pre-filtered by the
// CLOUDY_PIXEL_PERCENTAGE flag, to use only relatively
// cloud-free granule.

// run some tests here
if (true){
  // Function to mask clouds using the Sentinel-2 QA band.
  function maskS2clouds(image) {
    var qa = image.select('QA60')
  
    // Bits 10 and 11 are clouds and cirrus, respectively.
    var cloudBitMask = 1 << 10;
    var cirrusBitMask = 1 << 11;
  
    // Both flags should be set to zero, indicating clear conditions.
    var mask = qa.bitwiseAnd(cloudBitMask).eq(0).and(
               qa.bitwiseAnd(cirrusBitMask).eq(0))
  
    // Return the masked and scaled data, without the QA bands.
    return image.updateMask(mask) //.divide(10000)
        .select("B.*")
        .copyProperties(image, ["system:time_start"])
  }
  
  // Map the function over one year of data and take the median.
  // Load Sentinel-2 TOA reflectance data.
  var collection = ee.ImageCollection('COPERNICUS/S2')
      .filterDate('2018-01-01', '2018-12-31')
      // Pre-filter to get less cloudy granules.
      .filter(ee.Filter.lt('CLOUDY_PIXEL_PERCENTAGE', 20))
      .map(cropout_aoi)
      .map(maskS2clouds)
  
  // var composite = collection.median()
  var count = 4;
  // Display the results.
  Map.addLayer(collection, {bands: ['B4', 'B3', 'B2'], min: 0, max: 0.3*10000}, 'RGB')
  Export.image.toDrive({
                        image: collection.select(export_bands), 
                        description: description + count, 
                        folder: folder, 
                        fileNamePrefix: prefix_name + count, 
                        // dimensions, 
                        region: this_aoi, 
                        scale: 10
                        });
}



